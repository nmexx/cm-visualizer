<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MTG Sales Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Rajdhani:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:         #080b12;
    --bg2:        #0e1320;
    --bg3:        #141927;
    --border:     #1e2a3a;
    --gold:       #c9a227;
    --gold-light: #e8c547;
    --gold-dim:   #7a6018;
    --text:       #d4dbe8;
    --text-dim:   #6b7a94;
    --text-bright:#f0f4ff;
    --green:      #2ecc71;
    --red:        #e74c3c;
    --blue:       #3d8ef0;
    --purple:     #9b59b6;
    --foil:       #7ecfdd;
    --rare:       #c9a227;
    --mythic:     #e8752a;
    --uncommon:   #aab8c8;
    --common:     #9aa0a8;
    --radius:     8px;
    --glow:       0 0 20px rgba(201,162,39,0.15);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€ Top bar â”€â”€ */
  #topbar {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 0 20px;
    height: 52px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    position: relative;
  }

  .logo {
    font-family: 'Cinzel', serif;
    font-size: 17px;
    font-weight: 700;
    color: var(--gold);
    letter-spacing: 2px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap;
  }

  .logo-icon {
    width: 28px; height: 28px;
    background: var(--gold);
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .logo-icon::after {
    content: 'â—†';
    font-size: 12px;
    color: var(--bg);
  }

  .topbar-sep { width: 1px; height: 28px; background: var(--border); }

  .btn {
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    padding: 6px 14px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text);
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
  }

  .btn:hover { border-color: var(--gold-dim); color: var(--gold-light); background: #1a2035; }
  .btn.primary { border-color: var(--gold-dim); background: rgba(201,162,39,0.1); color: var(--gold-light); }
  .btn.primary:hover { background: rgba(201,162,39,0.2); }
  .btn.danger { border-color: #5a2020; color: #e74c3c; }
  .btn.danger:hover { background: rgba(231,76,60,0.1); }

  .topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }

  /* Date filters */
  .filter-row { display: flex; align-items: center; gap: 8px; }
  .filter-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
  .date-input {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    padding: 5px 10px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    width: 130px;
  }
  .date-input:focus { outline: none; border-color: var(--gold-dim); }

  /* â”€â”€ Status bar â”€â”€ */
  #statusbar {
    height: 28px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 0 20px;
    flex-shrink: 0;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
  }

  .status-item { display: flex; align-items: center; gap: 6px; }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-dim); }
  .status-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }

  /* â”€â”€ Main layout â”€â”€ */
  #app {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* â”€â”€ Sidebar nav â”€â”€ */
  #sidebar {
    width: 52px;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0;
    gap: 4px;
    flex-shrink: 0;
  }

  .nav-btn {
    width: 40px; height: 40px;
    border-radius: 6px;
    border: 1px solid transparent;
    background: none;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    transition: all 0.15s;
    color: var(--text-dim);
    position: relative;
  }

  .nav-btn:hover { background: var(--bg3); border-color: var(--border); color: var(--text); }
  .nav-btn.active { background: rgba(201,162,39,0.12); border-color: var(--gold-dim); color: var(--gold-light); }

  .nav-btn[data-tip]:hover::after {
    content: attr(data-tip);
    position: absolute;
    left: 48px;
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 4px 10px;
    border-radius: 4px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    color: var(--text);
    letter-spacing: 0.5px;
    z-index: 100;
    pointer-events: none;
  }

  /* â”€â”€ Content area â”€â”€ */
  #content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  /* â”€â”€ Pages â”€â”€ */
  .page { display: none; }
  .page.active { display: block; }

  /* â”€â”€ KPI cards â”€â”€ */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .kpi {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .kpi:hover { border-color: var(--gold-dim); }

  .kpi::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 3px; height: 100%;
    background: var(--gold);
    opacity: 0.6;
  }

  .kpi-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .kpi-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 26px;
    font-weight: 500;
    color: var(--text-bright);
    line-height: 1;
  }

  .kpi-sub {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .kpi-value.gold  { color: var(--gold-light); }
  .kpi-value.green { color: var(--green); }
  .kpi-value.blue  { color: var(--blue); }

  /* â”€â”€ Chart panels â”€â”€ */
  .charts-row {
    display: grid;
    gap: 12px;
    margin-bottom: 12px;
  }

  .charts-row.cols-2 { grid-template-columns: 1fr 1fr; }
  .charts-row.cols-3 { grid-template-columns: 2fr 1fr 1fr; }
  .charts-row.cols-12 { grid-template-columns: 1fr 2fr; }

  .panel {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }

  .panel-title {
    font-family: 'Cinzel', serif;
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--gold-dim);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .chart-wrap {
    position: relative;
  }

  /* â”€â”€ Table â”€â”€ */
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .data-table th {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    text-align: left;
    padding: 8px 10px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  .data-table td {
    padding: 7px 10px;
    border-bottom: 1px solid rgba(30,42,58,0.5);
    font-family: 'Rajdhani', sans-serif;
    font-weight: 500;
    color: var(--text);
  }

  .data-table tr:hover td { background: rgba(201,162,39,0.04); }
  .data-table .mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; }
  .data-table .gold { color: var(--gold-light); }
  .data-table .dim  { color: var(--text-dim); font-size: 12px; }

  /* Rarity badges */
  .badge {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    padding: 2px 7px;
    border-radius: 3px;
    text-transform: uppercase;
  }

  .badge-mythic    { background: rgba(232,117,42,0.2); color: var(--mythic); border: 1px solid rgba(232,117,42,0.3); }
  .badge-rare      { background: rgba(201,162,39,0.15); color: var(--gold-light); border: 1px solid rgba(201,162,39,0.25); }
  .badge-uncommon  { background: rgba(170,184,200,0.1); color: var(--uncommon); border: 1px solid rgba(170,184,200,0.2); }
  .badge-common    { background: rgba(154,160,168,0.1); color: var(--common); border: 1px solid rgba(154,160,168,0.2); }
  .badge-land      { background: rgba(61,142,240,0.1); color: var(--blue); border: 1px solid rgba(61,142,240,0.2); }
  .badge-foil      { background: rgba(126,207,221,0.15); color: var(--foil); border: 1px solid rgba(126,207,221,0.25); }
  .badge-pro       { background: rgba(155,89,182,0.15); color: var(--purple); border: 1px solid rgba(155,89,182,0.25); font-size:9px; }

  /* â”€â”€ Empty state â”€â”€ */
  #empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 70vh;
    gap: 20px;
    text-align: center;
  }

  .empty-icon {
    font-size: 64px;
    opacity: 0.3;
    filter: sepia(1) hue-rotate(10deg);
  }

  .empty-title {
    font-family: 'Cinzel', serif;
    font-size: 22px;
    color: var(--gold);
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .empty-sub {
    color: var(--text-dim);
    font-size: 15px;
    max-width: 380px;
    line-height: 1.6;
  }

  /* â”€â”€ Toast â”€â”€ */
  #toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px 20px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-bright);
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 1000;
    max-width: 340px;
  }

  #toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  #toast.success { border-color: rgba(46,204,113,0.4); }
  #toast.error   { border-color: rgba(231,76,60,0.4); }

  /* â”€â”€ Settings page â”€â”€ */
  .settings-group {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    max-width: 600px;
  }

  .settings-title {
    font-family: 'Cinzel', serif;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--gold-dim);
    margin-bottom: 16px;
  }

  .settings-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .settings-row label {
    font-size: 13px;
    color: var(--text-dim);
    width: 140px;
    flex-shrink: 0;
  }

  .path-display {
    flex: 1;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 6px 10px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* â”€â”€ Search box â”€â”€ */
  .search-input {
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    font-weight: 500;
    padding: 6px 12px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    width: 280px;
    margin-bottom: 12px;
  }
  .search-input:focus { outline: none; border-color: var(--gold-dim); }
  .search-input::placeholder { color: var(--text-dim); }

  /* â”€â”€ Scrollbar â”€â”€ */
  #content::-webkit-scrollbar { width: 6px; }
  #content::-webkit-scrollbar-track { background: transparent; }
  #content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€ Spinner â”€â”€ */
  .spinner {
    display: inline-block;
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Loading overlay â”€â”€ */
  #loading {
    position: fixed; inset: 0;
    background: rgba(8,11,18,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 500;
    flex-direction: column;
    gap: 16px;
  }

  #loading.show { display: flex; }
  #loading .load-text {
    font-family: 'Cinzel', serif;
    font-size: 14px;
    letter-spacing: 3px;
    color: var(--gold);
    text-transform: uppercase;
  }

  /* Page header */
  .page-header {
    font-family: 'Cinzel', serif;
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--gold);
    text-transform: uppercase;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .page-header::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(to right, var(--gold-dim), transparent);
    max-width: 300px;
  }
</style>
</head>
<body>

<!-- Top bar -->
<div id="topbar">
  <div class="logo">
    <div class="logo-icon"></div>
    MTG Dashboard
  </div>
  <div class="topbar-sep"></div>
  <div class="filter-row">
    <span class="filter-label">From</span>
    <input type="date" class="date-input" id="filter-from">
    <span class="filter-label">To</span>
    <input type="date" class="date-input" id="filter-to">
    <button class="btn primary" id="btn-apply-filter">Apply</button>
    <button class="btn" id="btn-clear-filter">Clear</button>
  </div>
  <div class="topbar-right">
    <button class="btn" id="btn-import-file">+ Import CSV</button>
    <button class="btn primary" id="btn-import-folder">âŸ³ Sync Folder</button>
  </div>
</div>

<!-- Status bar -->
<div id="statusbar">
  <div class="status-item">
    <div class="status-dot active" id="db-dot"></div>
    <span id="db-status">Database ready</span>
  </div>
  <div class="status-item">â—† <span id="status-orders">0 orders</span></div>
  <div class="status-item">â—† <span id="status-revenue">â‚¬0.00 revenue</span></div>
  <div class="status-item" style="margin-left:auto; font-family:'JetBrains Mono',monospace;" id="db-path-status"></div>
</div>

<div id="app">
  <!-- Sidebar -->
  <div id="sidebar">
    <button class="nav-btn active" data-page="overview" data-tip="Overview">ğŸ“Š</button>
    <button class="nav-btn" data-page="cards" data-tip="Cards">ğŸƒ</button>
    <button class="nav-btn" data-page="orders" data-tip="Orders">ğŸ“‹</button>
    <button class="nav-btn" data-page="sets" data-tip="Sets & Details">ğŸ´</button>
    <button class="nav-btn" style="margin-top:auto" data-page="settings" data-tip="Settings">âš™ï¸</button>
  </div>

  <!-- Content -->
  <div id="content">

    <!-- â”€â”€ OVERVIEW PAGE â”€â”€ -->
    <div class="page active" id="page-overview">
      <div id="empty-state" id="es">
        <div class="empty-icon">ğŸƒ</div>
        <div class="empty-title">No Data Yet</div>
        <div class="empty-sub">Import your Cardmarket CSV exports to start seeing your sales analytics.</div>
        <button class="btn primary" onclick="document.getElementById('btn-import-file').click()">Import CSV Files</button>
      </div>

      <div id="dashboard-content" style="display:none">
        <div class="page-header">Overview</div>

        <div class="kpi-grid" id="kpi-grid"></div>

        <div class="charts-row cols-2">
          <div class="panel">
            <div class="panel-title">Revenue over Time</div>
            <div class="chart-wrap" style="height:200px">
              <canvas id="chart-revenue-time"></canvas>
            </div>
          </div>
          <div class="panel">
            <div class="panel-title">Monthly Summary</div>
            <div class="chart-wrap" style="height:200px">
              <canvas id="chart-monthly"></canvas>
            </div>
          </div>
        </div>

        <div class="charts-row cols-3">
          <div class="panel">
            <div class="panel-title">Top Countries</div>
            <div class="chart-wrap" style="height:180px">
              <canvas id="chart-countries"></canvas>
            </div>
          </div>
          <div class="panel">
            <div class="panel-title">Foil vs Normal</div>
            <div class="chart-wrap" style="height:180px">
              <canvas id="chart-foil"></canvas>
            </div>
          </div>
          <div class="panel">
            <div class="panel-title">By Rarity</div>
            <div class="chart-wrap" style="height:180px">
              <canvas id="chart-rarity"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ CARDS PAGE â”€â”€ -->
    <div class="page" id="page-cards">
      <div class="page-header">Top Cards</div>
      <div class="charts-row cols-2" style="margin-bottom:16px">
        <div class="panel">
          <div class="panel-title">Revenue by Language</div>
          <div class="chart-wrap" style="height:200px"><canvas id="chart-language"></canvas></div>
        </div>
        <div class="panel">
          <div class="panel-title">Revenue by Rarity</div>
          <div class="chart-wrap" style="height:200px"><canvas id="chart-rarity2"></canvas></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title">Top 20 Cards by Revenue</div>
        <div style="overflow-x:auto">
          <table class="data-table" id="table-top-cards">
            <thead>
              <tr>
                <th>#</th>
                <th>Card Name</th>
                <th>Set</th>
                <th>Rarity</th>
                <th>Qty Sold</th>
                <th>Revenue</th>
                <th>In Orders</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ ORDERS PAGE â”€â”€ -->
    <div class="page" id="page-orders">
      <div class="page-header">Recent Orders</div>
      <div class="panel">
        <div class="panel-title">Last 50 Orders</div>
        <input type="text" class="search-input" id="orders-search" placeholder="Search by buyer, username, country or order IDâ€¦">
        <div style="overflow-x:auto">
          <table class="data-table" id="table-orders">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Buyer</th>
                <th>Country</th>
                <th>Articles</th>
                <th>Merchandise</th>
                <th>Total</th>
                <th>Commission</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ SETS PAGE â”€â”€ -->
    <div class="page" id="page-sets">
      <div class="page-header">Sets & Details</div>
      <div class="charts-row cols-2" style="margin-bottom:16px">
        <div class="panel">
          <div class="panel-title">Top Sets by Revenue</div>
          <div class="chart-wrap" style="height:260px"><canvas id="chart-sets"></canvas></div>
        </div>
        <div class="panel">
          <div class="panel-title">Revenue by Month</div>
          <div class="chart-wrap" style="height:260px"><canvas id="chart-monthly2"></canvas></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title">Sets Breakdown</div>
        <div style="overflow-x:auto">
          <table class="data-table" id="table-sets">
            <thead>
              <tr>
                <th>Set</th>
                <th>Cards Sold</th>
                <th>Revenue</th>
                <th>Share</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ SETTINGS PAGE â”€â”€ -->
    <div class="page" id="page-settings">
      <div class="page-header">Settings</div>

      <div class="settings-group">
        <div class="settings-title">Data Import</div>
        <div class="settings-row">
          <label>CSV Folder</label>
          <div class="path-display" id="setting-folder">Not configured</div>
          <button class="btn" id="btn-set-folder">Browse</button>
        </div>
        <div class="settings-row">
          <label>Database Path</label>
          <div class="path-display" id="setting-db-path">Loading...</div>
        </div>
      </div>

      <div class="settings-group">
        <div class="settings-title">Danger Zone</div>
        <div class="settings-row">
          <label>Clear all data</label>
          <button class="btn danger" id="btn-clear-db">Clear Database</button>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /app -->

<!-- Toast -->
<div id="toast"></div>

<!-- Loading -->
<div id="loading">
  <div class="spinner" style="width:36px;height:36px;border-width:3px"></div>
  <div class="load-text">Processing...</div>
</div>

<script>
// â”€â”€â”€ Chart.js global config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Chart.defaults.color = '#6b7a94';
Chart.defaults.borderColor = '#1e2a3a';
Chart.defaults.font.family = "'Rajdhani', sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.plugins.legend.labels.boxWidth = 12;
Chart.defaults.plugins.legend.labels.padding = 14;

const GOLD_PALETTE = [
  '#c9a227','#e8c547','#9b7b1e','#3d8ef0','#2ecc71',
  '#9b59b6','#e74c3c','#7ecfdd','#e8752a','#6b7a94'
];

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let charts = {};
let currentData = null;
let filters = {};

// â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.nav-btn[data-page]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('page-' + btn.dataset.page).classList.add('active');
  });
});

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type='success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + type;
  setTimeout(() => el.className = '', 3000);
}

function showLoading(v) {
  document.getElementById('loading').classList.toggle('show', v);
}

// â”€â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) {
  if (n === undefined || n === null) return 'â‚¬0.00';
  return 'â‚¬' + (+n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function fmtNum(n) {
  return (+n || 0).toLocaleString();
}

function rarityBadge(r) {
  if (!r) return '';
  const cls = { Mythic:'mythic', Rare:'rare', Uncommon:'uncommon', Common:'common', Land:'land' }[r] || 'common';
  return `<span class="badge badge-${cls}">${r}</span>`;
}

// â”€â”€â”€ Chart helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

function lineChart(id, labels, data, label='Revenue') {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if (!ctx) return;
  charts[id] = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label,
        data,
        borderColor: '#c9a227',
        backgroundColor: 'rgba(201,162,39,0.08)',
        tension: 0.4,
        fill: true,
        pointRadius: 3,
        pointBackgroundColor: '#c9a227'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#1e2a3a' }, ticks: { maxTicksLimit: 8 } },
        y: { grid: { color: '#1e2a3a' }, ticks: { callback: v => 'â‚¬'+v.toFixed(0) } }
      }
    }
  });
}

function barChart(id, labels, datasets, options={}) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if (!ctx) return;
  charts[id] = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: options.legend || { display: false } },
      scales: {
        x: { grid: { display: false }, ...(options.stacked ? { stacked: true } : {}) },
        y: { grid: { color: '#1e2a3a' }, ticks: { callback: v => 'â‚¬'+v.toFixed(0) }, ...(options.stacked ? { stacked: true } : {}) }
      },
      indexAxis: options.horizontal ? 'y' : 'x',
      ...options.extra
    }
  });
}

function doughnutChart(id, labels, data, colors) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if (!ctx) return;
  charts[id] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data, backgroundColor: colors || GOLD_PALETTE, borderWidth: 1, borderColor: '#080b12' }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11 } } }
      },
      cutout: '60%'
    }
  });
}

function hbarChart(id, labels, data, color='#c9a227') {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if (!ctx) return;
  charts[id] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ data, backgroundColor: color + '99', borderColor: color, borderWidth: 1 }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#1e2a3a' }, ticks: { callback: v => 'â‚¬'+v.toFixed(0) } },
        y: { grid: { display: false }, ticks: { font: { size: 11 } } }
      }
    }
  });
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(d) {
  currentData = d;
  const s = d.summary || {};

  // Show/hide empty state
  const hasData = (s.total_orders || 0) > 0;
  document.getElementById('empty-state').style.display = hasData ? 'none' : 'flex';
  document.getElementById('dashboard-content').style.display = hasData ? 'block' : 'none';

  if (!hasData) return;

  // Status bar
  document.getElementById('status-orders').textContent = fmtNum(s.total_orders) + ' orders';
  document.getElementById('status-revenue').textContent = fmt(s.total_revenue) + ' revenue';

  // â”€â”€ KPIs â”€â”€
  const netRevenue = (s.total_revenue || 0) - (s.total_commission || 0);
  const commissionRate = s.total_revenue > 0
    ? ((s.total_commission / s.total_revenue) * 100).toFixed(1) + '%'
    : '0%';
  const kpis = [
    { label: 'Total Revenue',    value: fmt(s.total_revenue),    cls: 'gold'  },
    { label: 'Net Revenue',      value: fmt(netRevenue),          cls: 'green' },
    { label: 'Orders',           value: fmtNum(s.total_orders),   cls: ''      },
    { label: 'Unique Buyers',    value: fmtNum(s.unique_buyers),  cls: 'blue'  },
    { label: 'Cards Sold',       value: fmtNum(s.total_articles), cls: ''      },
    { label: 'Avg Order Value',  value: fmt(s.avg_order_value),   cls: ''      },
    { label: 'Commission Rate',  value: commissionRate,           cls: ''      },
    { label: 'Commission Paid',  value: fmt(s.total_commission),  cls: ''      },
  ];

  document.getElementById('kpi-grid').innerHTML = kpis.map(k => `
    <div class="kpi">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value ${k.cls}">${k.value}</div>
    </div>
  `).join('');

  // â”€â”€ Revenue over time â”€â”€
  if (d.revenueByDay?.length) {
    lineChart('chart-revenue-time',
      d.revenueByDay.map(r => r.day),
      d.revenueByDay.map(r => r.revenue),
      'Daily Revenue'
    );
  }

  // â”€â”€ Monthly bar â”€â”€
  if (d.profitByMonth?.length) {
    barChart('chart-monthly',
      d.profitByMonth.map(r => r.month),
      [
        { label: 'Revenue', data: d.profitByMonth.map(r => r.revenue), backgroundColor: '#c9a22799', borderColor: '#c9a227', borderWidth: 1 },
        { label: 'Commission', data: d.profitByMonth.map(r => r.commission), backgroundColor: '#e74c3c66', borderColor: '#e74c3c', borderWidth: 1 }
      ],
      { legend: { display: true, labels: { color: '#6b7a94' } } }
    );
  }

  // â”€â”€ Countries â”€â”€
  if (d.revenueByCountry?.length) {
    hbarChart('chart-countries',
      d.revenueByCountry.slice(0,8).map(r => r.country),
      d.revenueByCountry.slice(0,8).map(r => r.revenue),
      '#3d8ef0'
    );
  }

  // â”€â”€ Foil â”€â”€
  if (d.foilVsNormal?.length) {
    const foilMap = {};
    d.foilVsNormal.forEach(r => { foilMap[r.is_foil] = r; });
    doughnutChart('chart-foil',
      ['Normal', 'Foil'],
      [foilMap[0]?.revenue || 0, foilMap[1]?.revenue || 0],
      ['#c9a227', '#7ecfdd']
    );
  }

  // â”€â”€ Rarity â”€â”€
  if (d.byRarity?.length) {
    const rarityColors = { Mythic:'#e8752a', Rare:'#c9a227', Uncommon:'#aab8c8', Common:'#9aa0a8' };
    doughnutChart('chart-rarity',
      d.byRarity.map(r => r.rarity),
      d.byRarity.map(r => r.revenue),
      d.byRarity.map(r => rarityColors[r.rarity] || '#6b7a94')
    );
  }

  // â”€â”€ Cards page â”€â”€
  if (d.byLanguage?.length) {
    hbarChart('chart-language',
      d.byLanguage.map(r => r.language),
      d.byLanguage.map(r => r.revenue),
      '#9b59b6'
    );
  }

  if (d.byRarity?.length) {
    const rarityColors = { Mythic:'#e8752a', Rare:'#c9a227', Uncommon:'#aab8c8', Common:'#9aa0a8' };
    doughnutChart('chart-rarity2',
      d.byRarity.map(r => r.rarity),
      d.byRarity.map(r => r.revenue),
      d.byRarity.map(r => rarityColors[r.rarity] || '#6b7a94')
    );
  }

  // â”€â”€ Top cards table â”€â”€
  const tcTbody = document.querySelector('#table-top-cards tbody');
  tcTbody.innerHTML = (d.topCards || []).map((c, i) => `
    <tr>
      <td class="mono dim">${i+1}</td>
      <td>${c.card_name}</td>
      <td class="dim">${c.set_name}</td>
      <td>${rarityBadge(c.rarity)}</td>
      <td class="mono">${fmtNum(c.qty_sold)}</td>
      <td class="mono gold">${fmt(c.revenue)}</td>
      <td class="mono dim">${c.in_orders}</td>
    </tr>
  `).join('');

  // â”€â”€ Orders table â”€â”€
  const ordTbody = document.querySelector('#table-orders tbody');
  ordTbody.innerHTML = (d.recentOrders || []).map(o => `
    <tr>
      <td class="mono dim">${o.order_id}</td>
      <td class="mono dim">${o.date_of_purchase?.substring(0,10) || ''}</td>
      <td>${o.buyer_name || o.username}${o.is_professional ? ' <span class="badge badge-pro">PRO</span>' : ''}</td>
      <td>${o.country}</td>
      <td class="mono">${o.article_count}</td>
      <td class="mono gold">${fmt(o.merchandise_value)}</td>
      <td class="mono">${fmt(o.total_value)}</td>
      <td class="mono dim">${fmt(o.commission)}</td>
    </tr>
  `).join('');
  filterOrders(); // re-apply any active search

  // â”€â”€ Sets page â”€â”€
  if (d.bySet?.length) {
    hbarChart('chart-sets',
      d.bySet.slice(0,10).map(r => r.set_name?.length > 28 ? r.set_name.substring(0,28)+'â€¦' : r.set_name),
      d.bySet.slice(0,10).map(r => r.revenue),
      '#2ecc71'
    );
  }

  if (d.profitByMonth?.length) {
    lineChart('chart-monthly2',
      d.profitByMonth.map(r => r.month),
      d.profitByMonth.map(r => r.revenue)
    );
  }

  const totalSetRev = (d.bySet || []).reduce((a,b) => a + (b.revenue||0), 0);
  const setTbody = document.querySelector('#table-sets tbody');
  setTbody.innerHTML = (d.bySet || []).map(s => `
    <tr>
      <td>${s.set_name}</td>
      <td class="mono">${fmtNum(s.qty)}</td>
      <td class="mono gold">${fmt(s.revenue)}</td>
      <td class="mono dim">${totalSetRev > 0 ? (s.revenue/totalSetRev*100).toFixed(1)+'%' : '-'}</td>
    </tr>
  `).join('');
}

// â”€â”€â”€ Orders live search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterOrders() {
  const q = document.getElementById('orders-search').value.toLowerCase().trim();
  const tbody = document.querySelector('#table-orders tbody');
  if (!tbody) return;
  Array.from(tbody.rows).forEach(row => {
    row.style.display = !q || row.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

document.getElementById('orders-search').addEventListener('input', filterOrders);

// â”€â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  const f = {};
  const from = document.getElementById('filter-from').value;
  const to   = document.getElementById('filter-to').value;
  if (from) f.dateFrom = from;
  if (to)   f.dateTo   = to;

  const data = await window.mtg.getStats(f);
  renderDashboard(data);
}

// â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-import-file').addEventListener('click', async () => {
  showLoading(true);
  const result = await window.mtg.importFile();
  showLoading(false);
  if (!result) return;
  toast(`Imported ${result.totalInserted} orders, ${result.totalSkipped} already existed`, 'success');
  loadData();
});

document.getElementById('btn-import-folder').addEventListener('click', async () => {
  const settings = await window.mtg.getSettings();
  const folder = settings.csv_folder;
  if (!folder) {
    toast('No folder configured â€” go to Settings first', 'error');
    return;
  }
  showLoading(true);
  const result = await window.mtg.importFolder(folder);
  showLoading(false);
  if (result.error) { toast(result.error, 'error'); return; }
  toast(`Synced: ${result.totalInserted} new, ${result.totalSkipped} existing`, 'success');
  loadData();
});

document.getElementById('btn-apply-filter').addEventListener('click', loadData);
document.getElementById('btn-clear-filter').addEventListener('click', () => {
  document.getElementById('filter-from').value = '';
  document.getElementById('filter-to').value = '';
  loadData();
});

// Settings
document.getElementById('btn-set-folder').addEventListener('click', async () => {
  const folder = await window.mtg.selectFolder();
  if (!folder) return;
  document.getElementById('setting-folder').textContent = folder;
  // Persist by importing from the folder immediately
  showLoading(true);
  const result = await window.mtg.importFolder(folder);
  showLoading(false);
  if (result.error) { toast(result.error, 'error'); return; }
  toast(`Folder set. Imported ${result.totalInserted} orders.`, 'success');
  loadData();
});

document.getElementById('btn-clear-db').addEventListener('click', async () => {
  if (!confirm('This will delete ALL sales data from the database. Are you sure?')) return;
  await window.mtg.clearDatabase();
  toast('Database cleared', 'success');
  loadData();
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const [settings, dbPath] = await Promise.all([
    window.mtg.getSettings(),
    window.mtg.getDbPath()
  ]);

  if (settings.csv_folder) {
    document.getElementById('setting-folder').textContent = settings.csv_folder;
  }

  document.getElementById('setting-db-path').textContent = dbPath || '';
  document.getElementById('db-path-status').textContent = dbPath ? dbPath.split(/[\\/]/).pop() : '';

  loadData();
}

init();
</script>
</body>
</html>
