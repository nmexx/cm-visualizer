<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MTG Sales Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Rajdhani:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Drag-drop overlay -->
<div id="drag-overlay">
  <div class="drag-inner">
    <div class="drag-icon">&#8659;</div>
    <div class="drag-text">Drop CSV file(s) to import</div>
  </div>
</div>

<!-- Update banner -->
<div id="update-banner" style="display:none">
  <span>&#8593; A new version is available.</span>
  <button class="btn update-btn" id="btn-install-update">Download &amp; Install</button>
  <button class="update-dismiss" id="btn-dismiss-update">&#10005;</button>
</div>

<!-- Top bar -->
<div id="topbar">
  <div class="logo">
    <div class="logo-icon"></div>
    MTG Dashboard
  </div>
  <div class="topbar-sep"></div>
  <div class="filter-row">
    <span class="filter-label">From</span>
    <input type="date" class="date-input" id="filter-from">
    <span class="filter-label">To</span>
    <input type="date" class="date-input" id="filter-to">
    <button class="btn primary" id="btn-apply-filter">Apply</button>
    <button class="btn" id="btn-clear-filter">Clear</button>
    <div class="preset-row" id="preset-row">
      <button class="btn preset-btn" data-days="30">30d</button>
      <button class="btn preset-btn" data-days="90">90d</button>
      <button class="btn preset-btn" data-days="365">1y</button>
      <button class="btn preset-btn" data-days="0">YTD</button>
      <div class="preset-saved-wrap">
        <select id="preset-select" class="preset-select"><option value="">&#9733; Presets</option></select>
        <button class="btn" id="btn-save-preset" title="Save current filter as preset">+</button>
      </div>
    </div>
  </div>
  <div class="topbar-right">
    <button class="btn icon-btn" id="btn-theme-toggle" title="Toggle light/dark theme">&#9788;</button>
    <button class="btn" id="btn-import-file">+ Sales CSV</button>
    <button class="btn buy" id="btn-import-purchases">+ Purchases CSV</button>
    <button class="btn primary" id="btn-import-folder">&#8635; Sync Folder</button>
  </div>
</div>

<!-- Status bar -->
<div id="statusbar">
  <div class="status-item">
    <div class="status-dot active" id="db-dot"></div>
    <span id="db-status">Database ready</span>
  </div>
  <div class="status-item">&#9670; <span id="status-orders">0 orders</span></div>
  <div class="status-item">&#9670; <span id="status-revenue">&#8364;0.00 revenue</span></div>
  <div class="status-item" style="margin-left:auto;font-family:JetBrains Mono,monospace;" id="db-path-status"></div>
</div>

<div id="app">
  <div id="sidebar">
    <button class="nav-btn active" data-page="overview"   data-tip="Overview">&#128202;</button>
    <button class="nav-btn"        data-page="cards"      data-tip="Cards">&#127183;</button>
    <button class="nav-btn"        data-page="orders"     data-tip="Orders">&#128203;</button>
    <button class="nav-btn"        data-page="sets"       data-tip="Sets">&#127924;</button>
    <button class="nav-btn"        data-page="purchases"  data-tip="Purchases">&#128176;</button>
    <button class="nav-btn"        data-page="pnl"        data-tip="P&amp;L &amp; Analytics">&#128200;</button>
    <button class="nav-btn"        data-page="inventory"  data-tip="Inventory">&#128230;</button>
    <button class="nav-btn" style="margin-top:auto" data-page="settings" data-tip="Settings">&#9881;&#65039;</button>
  </div>

  <div id="content">

    <!-- OVERVIEW -->
    <div class="page active" id="page-overview">
      <div id="empty-state" style="display:none">
        <div class="empty-icon">&#127183;</div>
        <div class="empty-title">No Data Yet</div>
        <div class="empty-sub">Import your Cardmarket Sold Orders CSV exports to start seeing analytics.</div>
        <button class="btn primary" onclick="document.getElementById('btn-import-file').click()">Import Sales CSV</button>
      </div>
      <div id="dashboard-content" style="display:none">
        <div class="page-header">Overview</div>
        <div id="missing-months-sales" class="missing-months-banner" style="display:none"></div>
        <div class="kpi-grid" id="kpi-grid"></div>
        <div class="charts-row cols-2">
          <div class="panel"><div class="panel-title">Revenue over Time</div>
            <div class="chart-wrap" style="height:200px"><canvas id="chart-revenue-time"></canvas></div></div>
          <div class="panel"><div class="panel-title">Monthly Summary</div>
            <div class="chart-wrap" style="height:200px"><canvas id="chart-monthly"></canvas></div></div>
        </div>
        <div class="charts-row cols-3">
          <div class="panel"><div class="panel-title">Top Countries</div>
            <div class="chart-wrap" style="height:180px"><canvas id="chart-countries"></canvas></div></div>
          <div class="panel"><div class="panel-title">Foil vs Normal</div>
            <div class="chart-wrap" style="height:180px"><canvas id="chart-foil"></canvas></div></div>
          <div class="panel"><div class="panel-title">By Rarity</div>
            <div class="chart-wrap" style="height:180px"><canvas id="chart-rarity"></canvas></div></div>
        </div>
      </div>
    </div>

    <!-- CARDS -->
    <div class="page" id="page-cards">
      <div class="page-header">Cards</div>
      <div style="display:flex;gap:8px;margin-bottom:12px;justify-content:flex-end">
        <button class="btn" id="btn-export-cards">&#8595; CSV</button>
        <button class="btn" id="btn-export-cards-xlsx">&#8595; XLSX</button>
      </div>
      <div class="charts-row cols-3">
        <div class="panel"><div class="panel-title">Revenue by Language</div>
          <div class="chart-wrap" style="height:200px"><canvas id="chart-language"></canvas></div></div>
        <div class="panel"><div class="panel-title">Revenue by Rarity</div>
          <div class="chart-wrap" style="height:200px"><canvas id="chart-rarity2"></canvas></div></div>
        <div class="panel"><div class="panel-title">Sold by Condition</div>
          <div class="chart-wrap" style="height:200px"><canvas id="chart-condition"></canvas></div></div>
      </div>
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">Top 20 Cards by Revenue</div>
        <div style="overflow-x:auto">
          <table class="data-table" id="table-top-cards">
            <thead><tr><th>#</th><th>Card Name</th><th>Set</th><th>Rarity</th><th>Qty Sold</th><th>Revenue</th><th>Share</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <!-- Foil Premium section -->
      <div class="panel">
        <div class="panel-title">Foil Premium Analysis — cards with both foil &amp; non-foil sales</div>
        <div style="overflow-x:auto">
          <table class="data-table" id="table-foil-premium">
            <thead><tr><th>Card</th><th>Set</th><th>Rarity</th><th>Normal Avg</th><th>Foil Avg</th><th>Premium</th><th>Qty Foil</th><th>Qty Normal</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ORDERS -->
    <div class="page" id="page-orders">
      <div class="page-header">Orders</div>
      <!-- Repeat Buyers Panel -->
      <div class="panel" style="margin-bottom:16px" id="repeat-buyers-panel" style="display:none">
        <div class="panel-title">Buyer Retention</div>
        <div class="kpi-grid" id="repeat-buyers-kpis" style="margin-bottom:12px"></div>
        <div class="charts-row cols-2">
          <div class="panel" style="border:none;padding:0">
            <div class="panel-title" style="margin-bottom:8px">Order Count Distribution</div>
            <div class="chart-wrap" style="height:160px"><canvas id="chart-buyer-distribution"></canvas></div>
          </div>
          <div class="panel" style="border:none;padding:0">
            <div class="panel-title" style="margin-bottom:8px">Top Repeat Buyers</div>
            <div style="overflow-x:auto">
              <table class="data-table" id="table-repeat-buyers">
                <thead><tr><th>Buyer</th><th>Orders</th><th>Revenue</th><th>Cards</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
          <input type="text" class="search-input" id="orders-search" placeholder="Search buyer, country, order ID&#8230;" style="margin-bottom:0">
          <button class="btn" id="btn-export-orders" style="margin-left:auto">&#8595; CSV</button>
          <button class="btn" id="btn-export-orders-xlsx">&#8595; XLSX</button>
        </div>
        <div style="overflow-x:auto">
          <table class="data-table" id="table-orders">
            <thead><tr>
              <th>Order ID</th><th>Date</th><th>Buyer</th><th>Country</th>
              <th>Articles</th><th>Merchandise</th><th>Total</th><th>Commission</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="pagination">
          <span class="page-info" id="orders-page-info"></span>
          <button class="btn" id="orders-prev">&#8249; Prev</button>
          <button class="btn" id="orders-next">Next &#8250;</button>
        </div>
      </div>
    </div>

    <!-- SETS -->
    <div class="page" id="page-sets">
      <div class="page-header">Sets &amp; Details</div>
      <div class="charts-row cols-2" style="margin-bottom:16px">
        <div class="panel"><div class="panel-title">Top Sets by Revenue</div>
          <div class="chart-wrap" style="height:260px"><canvas id="chart-sets"></canvas></div></div>
        <div class="panel"><div class="panel-title">Revenue by Month</div>
          <div class="chart-wrap" style="height:260px"><canvas id="chart-monthly2"></canvas></div></div>
      </div>
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">Sets Breakdown</div>
        <div style="overflow-x:auto">
          <table class="data-table" id="table-sets">
            <thead><tr><th>Set</th><th>Cards Sold</th><th>Revenue</th><th>Share</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <!-- Set ROI section -->
      <div class="panel">
        <div class="panel-title">Set ROI — avg buy price vs avg sell price (requires purchase data)</div>
        <div style="overflow-x:auto">
          <table class="data-table" id="table-set-roi">
            <thead><tr><th>Set</th><th>Bought</th><th>Sold</th><th>Avg Buy</th><th>Avg Sell</th><th>ROI</th><th>Cost</th><th>Revenue</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PURCHASES -->
    <div class="page" id="page-purchases">
      <div id="purchase-empty-state">
        <div class="empty-icon" style="font-size:64px;opacity:0.3">&#128176;</div>
        <div class="empty-title" style="font-family:Cinzel,serif;font-size:22px;color:var(--gold);letter-spacing:3px;text-transform:uppercase">No Purchase Data</div>
        <div class="empty-sub" style="color:var(--text-dim);font-size:15px;max-width:380px;line-height:1.6">Import your Cardmarket Purchased Orders CSV exports to track what you have bought.</div>
        <button class="btn buy" onclick="document.getElementById('btn-import-purchases').click()">Import Purchases CSV</button>
      </div>
      <div id="purchase-dashboard" style="display:none">
        <div class="page-header">Purchases</div>
        <div id="missing-months-purchases" class="missing-months-banner" style="display:none"></div>
        <div style="display:flex;gap:8px;margin-bottom:12px;justify-content:flex-end">
          <button class="btn" id="btn-export-purchases">&#8595; CSV</button>
          <button class="btn" id="btn-export-purchases-xlsx">&#8595; XLSX</button>
        </div>
        <div class="kpi-grid" id="purchase-kpi-grid"></div>
        <div class="charts-row cols-2">
          <div class="panel"><div class="panel-title">Spending over Time</div>
            <div class="chart-wrap" style="height:200px"><canvas id="chart-spend-time"></canvas></div></div>
          <div class="panel"><div class="panel-title">Monthly Spend &amp; Fees</div>
            <div class="chart-wrap" style="height:200px"><canvas id="chart-spend-monthly"></canvas></div></div>
        </div>
        <div class="charts-row cols-3">
          <div class="panel"><div class="panel-title">Top Sellers</div>
            <div class="chart-wrap" style="height:200px"><canvas id="chart-top-sellers"></canvas></div></div>
          <div class="panel"><div class="panel-title">By Country</div>
            <div class="chart-wrap" style="height:200px"><canvas id="chart-purchase-countries"></canvas></div></div>
          <div class="panel"><div class="panel-title">By Rarity</div>
            <div class="chart-wrap" style="height:200px"><canvas id="chart-purchase-rarity"></canvas></div></div>
        </div>
        <div class="panel" style="margin-bottom:16px">
          <div class="panel-title">Top 20 Purchased Cards</div>
          <div style="overflow-x:auto">
            <table class="data-table" id="table-bought-cards">
              <thead><tr><th>#</th><th>Card Name</th><th>Set</th><th>Rarity</th><th>Qty Bought</th><th>Spent</th><th>Orders</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="panel">
          <div class="panel-title">All Purchases</div>
          <div style="overflow-x:auto">
            <table class="data-table" id="table-purchases">
              <thead><tr>
                <th>Order ID</th><th>Date</th><th>Seller</th><th>Country</th>
                <th>Articles</th><th>Merchandise</th><th>Total</th><th>Trustee Fee</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- P&L / ANALYTICS -->
    <div class="page" id="page-pnl">
      <div id="pnl-empty-state">
        <div class="empty-icon" style="font-size:64px;opacity:0.3">&#128200;</div>
        <div class="empty-title" style="font-family:Cinzel,serif;font-size:22px;color:var(--gold);letter-spacing:3px;text-transform:uppercase">No Cross Data Yet</div>
        <div class="empty-sub" style="color:var(--text-dim);font-size:15px;max-width:400px;line-height:1.6">Import both Sold Orders and Purchased Orders CSVs to see P&amp;L, Set ROI, Foil Premium, and Time-to-Sell analytics.</div>
      </div>
      <div id="pnl-dashboard" style="display:none">
        <div class="page-header">P&amp;L &amp; Analytics</div>
        <div class="kpi-grid" id="pnl-kpi-grid"></div>
        <!-- P&L Table -->
        <div class="panel" style="margin-bottom:16px">
          <div class="panel-title">Profit &amp; Loss per Card (sold items matched against purchases)</div>
          <div style="display:flex;gap:8px;margin-bottom:8px;justify-content:flex-end">
            <button class="btn" id="btn-export-pnl">&#8595; CSV</button>
            <button class="btn" id="btn-export-pnl-xlsx">&#8595; XLSX</button>
          </div>
          <div style="overflow-x:auto">
            <table class="data-table" id="table-pnl">
              <thead><tr><th>Card</th><th>Set</th><th>Rarity</th><th>Bought</th><th>Sold</th><th>Avg Buy</th><th>Avg Sell</th><th>Cost</th><th>Revenue</th><th>Profit</th><th>Margin</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <!-- Time to Sell -->
        <div class="panel" style="margin-bottom:16px">
          <div class="panel-title">Time to Sell — days from first purchase to first sale per card</div>
          <div style="overflow-x:auto">
            <table class="data-table" id="table-time-to-sell">
              <thead><tr><th>Card</th><th>Set</th><th>First Bought</th><th>First Sold</th><th>Days to Sell</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- INVENTORY -->
    <div class="page" id="page-inventory">
      <div id="inventory-empty-state">
        <div class="empty-icon" style="font-size:64px;opacity:0.3">&#128230;</div>
        <div class="empty-title" style="font-family:Cinzel,serif;font-size:22px;color:var(--gold);letter-spacing:3px;text-transform:uppercase">No Inventory</div>
        <div class="empty-sub" style="color:var(--text-dim);font-size:15px;max-width:380px;line-height:1.6">Cards that have been purchased but not fully sold will appear here.</div>
      </div>
      <div id="inventory-dashboard" style="display:none">
        <div class="page-header">Inventory</div>
        <div class="kpi-grid" id="inventory-kpi-grid"></div>
        <div class="panel">
          <div class="panel-title">Cards on Hand</div>
          <div style="display:flex;gap:8px;margin-bottom:8px;justify-content:flex-end">
            <input type="text" class="search-input" id="inventory-search" placeholder="Search card or set&#8230;" style="margin-bottom:0;width:220px">
            <button class="btn" id="btn-export-inventory">&#8595; CSV</button>
            <button class="btn" id="btn-export-inventory-xlsx">&#8595; XLSX</button>
          </div>
          <div style="overflow-x:auto">
            <table class="data-table" id="table-inventory">
              <thead><tr><th>Card</th><th>Set</th><th>Rarity</th><th>Bought</th><th>Sold</th><th>On Hand</th><th>Avg Buy</th><th>Est. Value</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="page" id="page-settings">
      <div class="page-header">Settings</div>
      <div class="settings-group">
        <div class="settings-title">Appearance</div>
        <div class="settings-row">
          <label>Theme</label>
          <button class="btn" id="btn-toggle-theme">Switch to Light Theme</button>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-title">Data Import</div>
        <div class="settings-row">
          <label>CSV Folder</label>
          <div class="path-display" id="setting-folder">Not configured</div>
          <button class="btn" id="btn-set-folder">Browse</button>
        </div>
        <div class="settings-row">
          <label>Database Path</label>
          <div class="path-display" id="setting-db-path">Loading...</div>
        </div>
        <div class="settings-row">
          <label style="color:var(--text-dim);font-size:12px">Auto-sync is active when a folder is configured. New CSV files added to the folder are imported automatically.</label>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-title">Updates</div>
        <div class="settings-row">
          <label>App Version</label>
          <span id="app-version" style="font-family:JetBrains Mono,monospace;font-size:12px;color:var(--text-dim)">1.3.0</span>
        </div>
        <div class="settings-row">
          <label>Check for Updates</label>
          <button class="btn" id="btn-check-update">Check Now</button>
          <span id="update-status" style="font-size:12px;color:var(--text-dim);margin-left:8px"></span>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-title">Danger Zone</div>
        <div class="settings-row">
          <label>Clear all data</label>
          <button class="btn danger" id="btn-clear-db">Clear Database</button>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="toast"></div>
<div id="loading">
  <div class="spinner" style="width:36px;height:36px;border-width:3px"></div>
  <div class="load-text">Processing...</div>
</div>

<!-- Buyer detail modal -->
<div class="modal-overlay" id="buyer-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title-text">Buyer History</div>
      <button class="modal-close" id="modal-close">&#10005;</button>
    </div>
    <div class="modal-body">
      <div class="modal-kpis" id="modal-kpis"></div>
      <table class="data-table">
        <thead><tr><th>Date</th><th>Order ID</th><th>Articles</th><th>Merchandise</th><th>Commission</th></tr></thead>
        <tbody id="modal-orders-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Save preset modal -->
<div class="modal-overlay" id="preset-modal">
  <div class="modal" style="width:400px">
    <div class="modal-header">
      <div class="modal-title">Save Filter Preset</div>
      <button class="modal-close" id="preset-modal-close">&#10005;</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:12px;font-size:13px;color:var(--text-dim)">Give this date range a name to quickly apply it later.</div>
      <input type="text" class="search-input" id="preset-name-input" placeholder="e.g. Q1 2025" style="width:100%;margin-bottom:12px">
      <button class="btn primary" id="btn-confirm-save-preset">Save Preset</button>
    </div>
  </div>
</div>

<script src="vendor/chart.umd.min.js"></script>
<script src="renderer.js"></script>
</body>
</html>
